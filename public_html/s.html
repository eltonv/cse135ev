<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Analytics Dashboard</title>

  <!-- ZingChart for charts -->
  <script src="https://cdn.zingchart.com/zingchart.min.js"></script>
  <!-- ZingGrid for data table -->
  <script src="https://cdn.zinggrid.com/zinggrid.min.js"></script>

  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    h2 {
      color: #444;
      border-bottom: 2px solid #007bff;
      padding-bottom: 10px;
      margin-bottom: 30px;
    }

    .chart-container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chart {
      height: 600px;
      width: 100%;
      margin: 20px 0;
    }

    .grid-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .section {
      margin-bottom: 60px;
      clear: both;
    }

    zing-grid {
      width: 100%;
      min-height: 500px; 
      height: auto; 
      display: block;
      border-radius: 6px;
      overflow: hidden;

      --zg-head-background: #007bff;
      --zg-head-color: white;
      --zg-row-background-even: #f8f9fa;
      --zg-border-color: #dee2e6;
    }
  </style>
</head>
<body>

  <h1>Max Scroll Depth Analysis</h1>
  <div class="chart-container">
    <h2>Average Scroll Depth by Page</h2>
    <div id="scrollDepthChart" class="chart"></div>
  </div>

  <h1>Homepage Visit Heatmap</h1>
  <div class="chart-container">
    <div id="heatmap" style="height: 500px; width: 100%;"></div>
  </div>

  <div class="section">
    <h2>Reading Summary Data</h2>
    <div class="grid-container">
      <zing-grid editor="modal" sort filter pager page-size="15">
        <zg-data src="/api/reading_summary"></zg-data>
        <zg-column index="sessionId" header="Session ID"></zg-column>
        <zg-column index="pageUrl" header="Page URL"></zg-column>
        <zg-column index="referrer" header="Referring URL"></zg-column>
        <zg-column index="finalScrollDepth" header="Final Scroll Depth (%)"></zg-column>
        <zg-column index="totalReadingTime" header="Total Reading Time (s)"></zg-column>
        <zg-column index="timeOnPage" header="Time on Page (s)"></zg-column>
        <zg-column index="readingRatio" header="Reading Ratio (%)"></zg-column>
        <zg-column index="timestamp" header="Timestamp"></zg-column>
      </zing-grid>
    </div>
  </div>

  <script>
    // ================= Scroll Depth Chart =================
    async function loadScrollData() {
      try {
        const response = await fetch('/api/activity');
        const allData = await response.json();

        const scrollData = allData.filter(item =>
          item.type === 'scroll' &&
          item.scrollY !== null &&
          item.scrollY !== undefined &&
          item.pageUrl
        );

        const sessionPageData = {};
        scrollData.forEach(item => {
          const key = `${item.sessionId}|${item.pageUrl}`;
          if (!sessionPageData[key]) {
            sessionPageData[key] = {
              sessionId: item.sessionId,
              pageUrl: item.pageUrl,
              maxScrollY: 0,
              scrollEvents: 0,
              timestamps: []
            };
          }
          sessionPageData[key].maxScrollY = Math.max(sessionPageData[key].maxScrollY, item.scrollY);
          sessionPageData[key].scrollEvents++;
          sessionPageData[key].timestamps.push(new Date(item.timestamp));
        });

        const processedData = Object.values(sessionPageData);
        createAvgScrollDepthChart(processedData);
      } catch (error) {
        console.error('Error loading scroll data:', error);
      }
    }

    function createAvgScrollDepthChart(data) {
      const pageData = {};
      data.forEach(item => {
        const pagePath = new URL(item.pageUrl).pathname || 'Home';
        if (!pageData[pagePath]) {
          pageData[pagePath] = { total:0, count:0, sessions:new Set(), scrollEvents:0 };
        }
        pageData[pagePath].total += item.maxScrollY;
        pageData[pagePath].count++;
        pageData[pagePath].sessions.add(item.sessionId);
        pageData[pagePath].scrollEvents += item.scrollEvents;
      });

      const avgData = Object.entries(pageData).map(([page, stats]) => ({
        page: page === '/' ? 'Home' : page,
        avgScroll: Math.round(stats.total / stats.count),
        uniqueSessions: stats.sessions.size,
        totalVisits: stats.count,
        totalScrollEvents: stats.scrollEvents
      }));

      avgData.sort((a,b)=>b.avgScroll-a.avgScroll);
      const labels = avgData.map(item => item.page.length>15 ? item.page.substring(0,12)+'...' : item.page);

      const config = {
        type: 'bar',
        title: { text:'Average Scroll Depth by Page', fontSize:18, fontWeight:'bold', marginTop:10 },
        'scale-x': { labels, item:{'font-size':11,'max-chars':15}, 'offset-start':40,'offset-end':40 },
        'scale-y': { label:{text:'Average Scroll Depth (pixels)','font-size':14}, 'offset-start':60 },
        'plot-area': { 'margin-top':80,'margin-bottom':80,'margin-left':80,'margin-right':40 },
        series: [{
          values: avgData.map(item=>item.avgScroll),
          'background-color':'#007bff',
          'border-radius':'4px',
          'hover-state':{'background-color':'#0056b3'},
          'data-sessions': avgData.map(item=>item.uniqueSessions),
          'data-visits': avgData.map(item=>item.totalVisits),
          'data-events': avgData.map(item=>item.totalScrollEvents),
          'data-full-names': avgData.map(item=>item.page)
        }],
        tooltip: { text:'Page: %data-full-names<br>Avg Scroll Depth: %v pixels<br>Unique Sessions: %data-sessions<br>Total Visits: %data-visits<br>Total Scroll Events: %data-events',
                  'background-color':'rgba(0,0,0,0.8)','border-radius':4,'font-color':'white','font-size':12 }
      };

      zingchart.render({ id:'scrollDepthChart', data:config, height:600, width:'100%' });
    }

    // ================= Heatmap Chart =================
    async function loadHeatmapData() {
      try {
        const res = await fetch('/api/activity');
        const data = await res.json();

        const days = ["Su","Mo","Tu","We","Th","Fr","Sa"];
        let matrix = Array.from({ length: 7 }, () => Array(24).fill(0));

        data.forEach(entry => {
          const d = new Date(entry.timestamp);
          const day = d.getDay();
          const hour = d.getHours();
          matrix[day][hour] += 1;
        });

        const series = [];
        for (let day = 0; day < 7; day++) {
          series.push({ text: days[day], values: matrix[day] });
        }

        const chartConfig = {
          globals: { fontFamily: 'Roboto' },
          graphset: [{
            type: 'piano',
            backgroundColor: '#fff',
            title: { text: 'Activity on Home Page', fontSize: '20px', adjustLayout: true },
            plot: {
              tooltip: { text: 'Entries: %v', fontColor: 'white' },
              rules: [
                { backgroundColor: '#7FCDBB', rule: '%node-value <= 1' },
                { backgroundColor: '#41B6C4', rule: '%node-value > 1 && %node-value <= 3' },
                { backgroundColor: '#1D91C0', rule: '%node-value > 3 && %node-value <= 5' },
                { backgroundColor: '#225EA8', rule: '%node-value > 5 && %node-value <= 10' },
                { backgroundColor: '#253494', rule: '%node-value > 10 && %node-value <= 20' },
                { backgroundColor: '#081D58', rule: '%node-value > 20' }
              ]
            },
            scaleX: { values:[...Array(24).keys()].map(String), placement:'opposite' },
            scaleY: { values:days, mirrored:true },
            series: series
          }]
        };

        zingchart.render({ id:'heatmap', data:chartConfig, height:500, width:'100%' });
      } catch (err) {
        console.error("Error loading heatmap:", err);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadScrollData();
      loadHeatmapData();
    });
  </script>

  
</body>
</html>
